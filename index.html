<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Dashboard - Logistics Performance (Cloud Sync)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Datalabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <!-- PapaParse for CSV Parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f8fafc; 
            color: #334155; 
        }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .card-hoverable {
            transition: all 0.3s ease;
        }
        .card-hoverable:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }

        .input-modern {
            background-color: #f1f5f9;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .input-modern:focus {
            background-color: #ffffff;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .note-input {
            transition: border-color 0.3s, background-color 0.3s;
        }
        .note-saved {
            border-color: #10b981 !important;
            background-color: #ecfdf5 !important;
        }
        
        .upload-loading {
            pointer-events: none;
            opacity: 0.7;
            background-color: #f1f5f9;
            cursor: wait !important;
        }

        /* Status Indicator */
        .status-dot {
            height: 8px; width: 8px; border-radius: 50%; display: inline-block;
        }
        .status-online { background-color: #10b981; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); }
        .status-offline { background-color: #ef4444; }
        .status-syncing { background-color: #f59e0b; animation: pulse 1s infinite; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* Auth Modal Animation */
        #authModal { transition: opacity 0.2s ease-in-out; }
        #authModal.hidden { opacity: 0; pointer-events: none; }
        #authModal:not(.hidden) { opacity: 1; pointer-events: auto; }

        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .card-hoverable { box-shadow: none; border: 1px solid #e2e8f0; }
        }
    </style>
</head>
<body class="bg-slate-50">

    <!-- AUTH MODAL (SYSTEM POPUP) -->
    <div id="authModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/40 backdrop-blur-sm hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform scale-100 transition-transform">
            <div class="flex items-center gap-3 mb-4">
                <div class="p-2 bg-indigo-100 text-indigo-600 rounded-lg">
                    <i class="fas fa-lock fa-lg"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-slate-800">Akses Editor</h1>
                    <p class="text-xs text-slate-500">Masukkan PIN untuk membuka kunci.</p>
                </div>
            </div>
            
            <div class="mb-4">
                <input type="password" id="modalPassInput" 
                    class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 text-slate-800 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition"
                    placeholder="Masukkan Password..."
                    onkeypress="if(event.key === 'Enter') confirmAuth()">
                <p id="modalErrorMsg" class="text-xs text-rose-500 mt-2 font-medium hidden">
                    <i class="fas fa-exclamation-circle mr-1"></i> Password salah!
                </p>
            </div>

            <div class="flex gap-3">
                <button onclick="closeAuthModal()" class="flex-1 px-4 py-2.5 rounded-xl text-xs font-bold text-slate-500 hover:bg-slate-100 transition">
                    Batal
                </button>
                <button onclick="confirmAuth()" class="flex-1 px-4 py-2.5 rounded-xl text-xs font-bold text-white bg-indigo-600 hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition">
                    Buka Kunci
                </button>
            </div>
        </div>
    </div>

    <!-- TOP NAVIGATION -->
    <nav class="bg-white/80 backdrop-blur-md border-b border-slate-200 sticky top-0 z-50">
        <div class="w-full px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-600 text-white p-2 rounded-xl shadow-lg shadow-indigo-200">
                        <i class="fas fa-boxes-stacked fa-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-slate-800 leading-tight">Logistics Ops</h1>
                        <div class="text-xs text-slate-500 font-medium flex items-center gap-2">
                            Cloud Dashboard
                            <span class="flex items-center gap-1.5 bg-slate-100 px-2 py-0.5 rounded-full border border-slate-200">
                                <span id="syncStatusDot" class="status-dot status-offline"></span>
                                <span id="syncStatusText" class="text-[10px] font-bold text-slate-600">Connecting...</span>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="hidden md:flex items-center gap-4">
                    <div class="text-right">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Report Date</p>
                        <p class="text-sm font-semibold text-slate-700" id="currentDateDisplay">-</p>
                    </div>
                    <div class="h-8 w-px bg-slate-200"></div>
                    <button onclick="window.print()" class="text-slate-500 hover:text-indigo-600 transition p-2 rounded-lg hover:bg-indigo-50">
                        <i class="fas fa-print fa-lg"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="w-full px-4 sm:px-6 lg:px-8 py-8 space-y-8">

        <!-- 1. HERO & CONTROLS -->
        <div class="no-print bg-white rounded-2xl shadow-sm border border-slate-200 p-1">
            <div class="bg-slate-50 rounded-xl p-6 border border-slate-100">
                <div class="flex flex-col lg:flex-row gap-6 justify-between items-end">
                    
                    <!-- Upload -->
                    <div class="w-full lg:w-1/3">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-xs font-bold text-indigo-600 uppercase tracking-wider">
                                <i class="fas fa-cloud-upload-alt mr-1"></i> Update Data (Global)
                            </label>
                        </div>
                        <label id="dropZone" class="flex flex-col w-full h-14 border-2 border-dashed border-slate-300 rounded-xl hover:bg-indigo-50 hover:border-indigo-300 transition cursor-pointer group items-center justify-center relative bg-white">
                            <div class="flex items-center gap-2 text-slate-400 group-hover:text-indigo-600 transition">
                                <i class="fas fa-file-csv fa-lg"></i>
                                <span class="text-sm font-medium" id="uploadText">Upload CSV (Append Mode)</span>
                            </div>
                            <input type="file" id="csvUpload" accept=".csv" class="opacity-0 absolute inset-0 cursor-pointer" />
                        </label>
                        <p class="text-[10px] text-slate-500 mt-1 ml-1 font-medium flex items-center">
                            <i class="fas fa-info-circle mr-1 text-blue-500"></i>
                            Validasi unik berdasarkan kolom "No Bagseals". Data duplikat di-skip otomatis.
                        </p>
                    </div>

                    <!-- Filters -->
                    <div class="w-full lg:w-2/3 grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Mulai Tgl Terima</label>
                            <input type="date" id="filterStartDate" class="w-full input-modern rounded-lg px-3 py-2 text-xs font-medium text-slate-700 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Sampai Tgl Terima</label>
                            <input type="date" id="filterEndDate" class="w-full input-modern rounded-lg px-3 py-2 text-xs font-medium text-slate-700 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Filter Vendor</label>
                            <div class="relative">
                                <select id="filterVendor" class="w-full input-modern rounded-lg px-3 py-2 text-xs font-medium text-slate-700 appearance-none focus:outline-none">
                                    <option value="all">Semua Vendor</option>
                                </select>
                                <i class="fas fa-chevron-down absolute right-3 top-2.5 text-xs text-slate-400 pointer-events-none"></i>
                            </div>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Filter Destinasi</label>
                            <div class="relative">
                                <select id="filterDest" class="w-full input-modern rounded-lg px-3 py-2 text-xs font-medium text-slate-700 appearance-none focus:outline-none">
                                    <option value="all">Semua Destinasi</option>
                                </select>
                                <i class="fas fa-chevron-down absolute right-3 top-2.5 text-xs text-slate-400 pointer-events-none"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Apply Btn -->
                    <div class="w-full lg:w-auto">
                        <button onclick="applyFilters()" class="w-full h-10 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold px-6 rounded-lg shadow-md shadow-indigo-200 transition active:scale-95 flex items-center justify-center gap-2">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. KPI METRICS -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
            <!-- Metric 1: Total Koli -->
            <div class="bg-white rounded-2xl p-5 border border-slate-100 shadow-sm card-hoverable">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600">
                        <i class="fas fa-box-open"></i>
                    </div>
                    <span class="text-xs font-bold text-slate-400 bg-slate-50 px-2 py-1 rounded-full">Total Koli (MB)</span>
                </div>
                <h3 class="text-2xl font-bold text-slate-800" id="totalShipments">0</h3>
                <p class="text-xs text-slate-500 mt-1">Total Master Bag</p>
            </div>

            <!-- Metric 2: Total Qty Parcel -->
            <div class="bg-white rounded-2xl p-5 border border-slate-100 shadow-sm card-hoverable">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-10 h-10 rounded-full bg-violet-50 flex items-center justify-center text-violet-600">
                        <i class="fas fa-cubes"></i>
                    </div>
                    <span class="text-xs font-bold text-slate-400 bg-slate-50 px-2 py-1 rounded-full">Total Qty Parcel</span>
                </div>
                <h3 class="text-2xl font-bold text-slate-800" id="totalParcels">0</h3>
                <p class="text-xs text-slate-500 mt-1">Unit paket (Pcs)</p>
            </div>

            <!-- Metric 3: Total Berat -->
            <div class="bg-white rounded-2xl p-5 border border-slate-100 shadow-sm card-hoverable">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-10 h-10 rounded-full bg-amber-50 flex items-center justify-center text-amber-600">
                        <i class="fas fa-weight-hanging"></i>
                    </div>
                    <span class="text-xs font-bold text-slate-400 bg-slate-50 px-2 py-1 rounded-full">Total Berat</span>
                </div>
                <div class="flex items-end gap-2">
                    <h3 class="text-2xl font-bold text-slate-800" id="totalWeight">0</h3>
                    <span class="text-sm font-medium text-slate-400 mb-1">Kg</span>
                </div>
                <p class="text-xs text-slate-500 mt-1">Tonase keseluruhan</p>
            </div>

            <!-- Metric 4: Rata-rata SLA -->
            <div class="bg-white rounded-2xl p-5 border border-slate-100 shadow-sm card-hoverable">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-10 h-10 rounded-full bg-teal-50 flex items-center justify-center text-teal-600">
                        <i class="fas fa-stopwatch"></i>
                    </div>
                    <span class="text-xs font-bold text-slate-400 bg-slate-50 px-2 py-1 rounded-full">Rata-rata SLA</span>
                </div>
                <div class="flex items-end gap-2 mb-2">
                    <h3 class="text-2xl font-bold text-slate-800" id="avgSLA">0</h3>
                    <span class="text-sm font-medium text-slate-400 mb-1">Hari</span>
                </div>
                <div class="flex items-center gap-3 text-[10px] font-medium border-t border-slate-50 pt-2">
                    <div class="flex items-center text-emerald-600">
                        <i class="fas fa-bolt mr-1"></i> <span id="minSLA">0</span> H (Cepat)
                    </div>
                    <div class="h-3 w-px bg-slate-200"></div>
                    <div class="flex items-center text-rose-500">
                        <i class="fas fa-hourglass-end mr-1"></i> <span id="maxSLA">0</span> H (Lama)
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. VISUALIZATIONS -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- SLA Chart: 25% Width -->
            <div class="lg:col-span-1 bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
                <h3 class="text-sm font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <span class="w-1 h-4 bg-indigo-500 rounded-full"></span>
                    Performa SLA (PA ke Handover)
                </h3>
                <div class="h-64">
                    <canvas id="slaDestChart"></canvas>
                </div>
            </div>
            <!-- Volume Chart: 75% Width -->
            <div class="lg:col-span-3 bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
                <h3 class="text-sm font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <span class="w-1 h-4 bg-teal-500 rounded-full"></span>
                    Volume Harian (Berdasarkan Tgl Terima)
                </h3>
                <div class="h-64">
                    <canvas id="volumeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 4. TABEL ANALISA VENDOR -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
            <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <div>
                    <h3 class="text-sm font-bold text-slate-800">Analisa Vendor & Destinasi</h3>
                    <p class="text-xs text-slate-500">Breakdown SLA (PA ke Handover) & Waktu Kedatangan</p>
                </div>
                <div class="text-indigo-600 bg-indigo-50 p-2 rounded-lg">
                    <i class="fas fa-chart-simple"></i>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 text-[11px] uppercase font-bold text-slate-500 tracking-wider">
                        <tr id="vendorTableHeader">
                            <!-- JS Injection -->
                        </tr>
                    </thead>
                    <tbody class="text-xs sm:text-sm divide-y divide-slate-50" id="vendorTableBody">
                        <!-- JS Injection -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 5. NEW: DETAIL DISTRIBUSI SLA -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden mb-8">
            <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <div>
                    <h3 class="text-sm font-bold text-slate-800">Detail Distribusi SLA</h3>
                    <p class="text-xs text-slate-500">Sebaran MB & Qty berdasarkan durasi pengiriman (Hari)</p>
                </div>
                <div class="text-emerald-600 bg-emerald-50 p-2 rounded-lg">
                    <i class="fas fa-sitemap"></i>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 text-[11px] uppercase font-bold text-slate-500 tracking-wider" id="slaDistHeader">
                        <!-- JS Injection -->
                    </thead>
                    <tbody class="text-xs sm:text-sm divide-y divide-slate-50" id="slaDistBody">
                        <!-- JS Injection -->
                    </tbody>
                    <tfoot class="bg-indigo-50/80 border-t-2 border-indigo-100 font-bold text-xs" id="slaDistFooter">
                        <!-- Footer JS Injection -->
                    </tfoot>
                </table>
            </div>
            <!-- LEGEND -->
            <div class="px-6 py-3 bg-slate-50 border-t border-slate-100 text-[10px] text-slate-500 italic flex items-center justify-end">
                <i class="fas fa-info-circle mr-1.5 text-blue-400"></i>
                <span>Nilai atas (Biru): <span class="font-bold text-slate-600">Total MB</span> &nbsp;|&nbsp; Nilai bawah (Hijau): <span class="font-bold text-slate-600">Total Qty Parcel</span></span>
            </div>
        </div>

        <!-- 6. TABEL REKAPITULASI (MAIN DATA) -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden print-break">
            <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <div>
                    <h3 class="text-sm font-bold text-slate-800">Rekapitulasi Muatan & Kapal</h3>
                    <p class="text-xs text-slate-500">Log harian kedatangan kapal & catatan lapangan (Real-Time Sync)</p>
                </div>
                <div class="text-teal-600 bg-teal-50 p-2 rounded-lg">
                    <i class="fas fa-ship"></i>
                </div>
            </div>
            <div class="overflow-x-auto max-h-[800px]">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 text-[11px] uppercase font-bold text-slate-500 tracking-wider sticky top-0 z-10 shadow-sm border-b border-slate-200">
                        <tr>
                            <th class="px-6 py-4 w-[120px] bg-slate-50 whitespace-nowrap bg-indigo-50/30">Handover SS</th>
                            <th class="px-6 py-4 w-[160px] bg-slate-50 whitespace-nowrap">Waktu Terima</th>
                            <th class="px-6 py-4 bg-slate-50 border-l border-slate-100 whitespace-nowrap">Komposisi PA</th>
                            <th class="px-6 py-4 bg-slate-50 text-center whitespace-nowrap">Batch</th>
                            <th class="px-6 py-4 text-right bg-slate-50 whitespace-nowrap">Total MB</th>
                            <th class="px-6 py-4 text-right bg-slate-50 whitespace-nowrap">Total Qty</th>
                            <th class="px-6 py-4 text-center bg-slate-50 whitespace-nowrap">SLA (PA)</th>
                            <th class="px-6 py-4 bg-slate-50 border-l border-slate-100 whitespace-nowrap">Nama Kapal</th>
                            <th class="px-6 py-4 bg-slate-50 whitespace-nowrap">Vendor</th>
                            <th class="px-6 py-4 bg-slate-50 whitespace-nowrap">Destinasi</th>
                            <th class="px-6 py-4 w-[600px] bg-yellow-50 text-yellow-700 border-l border-yellow-200 whitespace-nowrap">
                                <i class="fas fa-lock mr-1" id="lockIcon"></i> Catatan
                            </th>
                        </tr>
                    </thead>
                    <tbody class="text-xs sm:text-sm" id="tableBody">
                        <!-- JS Injection -->
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <!-- FIREBASE MODULE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, writeBatch } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAxpxGSwq9iTeDBNqW1pZMOTu_-KGt6iK4",
            authDomain: "logsheet-5r.firebaseapp.com",
            projectId: "logsheet-5r",
            storageBucket: "logsheet-5r.firebasestorage.app",
            messagingSenderId: "358725557740",
            appId: "1:358725557740:web:c3493a376e2f70711ff4c9"
        };

        const APP_ID = 'logsheet_dashboard_v1';
        let db;

        // INIT FIREBASE
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            const auth = getAuth(app);

            signInAnonymously(auth).then(() => {
                updateStatus('online', 'Connected');
                initListeners();
            }).catch(e => {
                console.error(e);
                updateStatus('offline', 'Auth Failed');
            });

        } catch(e) {
            console.error(e);
            updateStatus('offline', 'Config Error');
        }

        function updateStatus(state, text) {
            const dot = document.getElementById('syncStatusDot');
            const txt = document.getElementById('syncStatusText');
            if(dot && txt) {
                dot.className = `status-dot status-${state}`;
                txt.innerText = text;
            }
        }

        // --- LISTENERS ---
        function initListeners() {
            // 1. Listen for Main Data Changes (Koleksi shipments)
            const shipmentsCol = collection(db, 'artifacts', APP_ID, 'public', 'data', 'shipments');
            
            onSnapshot(shipmentsCol, (snapshot) => {
                const data = snapshot.docs.map(doc => doc.data());
                console.log(`Cloud Sync: Received ${data.length} records.`);
                
                if (data.length > 0) {
                    if (window.processRawData) window.processRawData({ data: data });
                } else {
                    if (window.loadSample) window.loadSample();
                }
            }, (error) => {
                console.error("Data Listen Error:", error);
            });

            // 2. Listen for Notes Changes
            const notesCol = collection(db, 'artifacts', APP_ID, 'public', 'data', 'field_notes');
            onSnapshot(notesCol, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const data = change.doc.data();
                    const key = change.doc.id;
                    if(window.updateLocalNote) window.updateLocalNote(key, data.text); 
                    
                    const el = document.getElementById(`note-${key}`);
                    if (el && document.activeElement !== el) {
                        el.value = data.text;
                    }
                });
            });
        }

        // --- PUBLIC FUNCTIONS ---

        // 1. Upload CSV to Cloud (Collection Based + Batching)
        window.uploadDataToCloud = async (newRows) => {
            if (!db) {
                alert("Database belum terkoneksi.");
                return;
            }
            updateStatus('syncing', 'Uploading in batches...');
            
            try {
                let addedCount = 0;
                let batch = writeBatch(db);
                let opCount = 0;

                for (const row of newRows) {
                    const bagSeal = row['No Bagseals'];
                    if (bagSeal && bagSeal.trim() !== "") {
                        const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'shipments', bagSeal);
                        
                        batch.set(docRef, {
                            ...row,
                            uploadedAt: new Date().toISOString()
                        }, { merge: true });

                        opCount++;
                        addedCount++;

                        if (opCount === 450) { 
                            await batch.commit();
                            batch = writeBatch(db);
                            opCount = 0;
                            updateStatus('syncing', `Progress: ${addedCount} rows...`);
                        }
                    }
                }

                if (opCount > 0) await batch.commit();

                updateStatus('online', 'Data Synced');
                alert(`Upload Selesai!\nProses data: ${newRows.length}\nBerhasil sinkronisasi ke cloud.`);

            } catch (e) {
                console.error("Upload Failed:", e);
                updateStatus('offline', 'Upload Failed');
                alert("Gagal upload. Masalah koneksi atau izin database.");
            }
        };

        // 2. Save Note
        window.saveNoteToFirebase = async (key, value) => {
            if (!db) return;
            try {
                const noteRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'field_notes', key);
                await setDoc(noteRef, { 
                    text: value,
                    updatedAt: new Date().toISOString()
                }, { merge: true });
                
                const el = document.getElementById(`note-${key}`);
                if(el) {
                    el.classList.add('note-saved');
                    setTimeout(() => el.classList.remove('note-saved'), 1000);
                }
            } catch (e) {
                console.error("Note Save Error:", e);
            }
        };
    </script>

    <!-- MAIN APP LOGIC -->
    <script>
        const MONTH_NAMES = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Ags", "Sep", "Okt", "Nov", "Des"];
        let allProcessedData = []; 
        let globalNotes = {}; 
        let chartSlaDest = null;
        let chartVolume = null;
        
        // --- AUTH VARS ---
        let isAuthorized = false;
        let pendingAuthEl = null;

        // Set Date
        const today = new Date();
        const displayDate = today.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        document.getElementById('currentDateDisplay').innerText = displayDate;

        window.updateLocalNote = (key, text) => { globalNotes[key] = text; }

        window.loadSample = () => {
            const sample = `Tanggal,BATCH,Origin,VENDOR,SERVICE,Destinasi,SMU,FLIGHT,TANGGAL FLIGHT,ETD,No Bagseals,Berat Total (kg),Kuantitas Paket (Awb),Note,CATATAN,"ATA\nTanggal & jam","Penarikan\nTanggal & Jam",Tanggal DIterima,JAM
01 Jan 2026,1,Surabaya,SMI,ECO,Balikpapan,243215,Km. Dharma Kencana 5 ,03 Jan 2026,11:15,40000560239139,14,23,,,,,04 Jan 2026,21:40
01 Jan 2026,1,Surabaya,SMI,ECO,Balikpapan,243215,Km. Dharma Kencana 5 ,03 Jan 2026,11:15,40000591499678,14,15,,,,,04 Jan 2026,21:40
13 Feb 2026,2,Surabaya,BSM,ECO,BANJARMASIN,3039,Dharma Kartika 2,14 Feb 2026,23:00,40000594721644,5,1,,,,,15 Feb 2026,02:30`;
            Papa.parse(sample, { header: true, skipEmptyLines: true, complete: function(results) { processRawData(results); } });
        };

        document.getElementById('csvUpload').addEventListener('change', function(e) { 
            if(e.target.files[0]) {
                const dropZone = document.getElementById('dropZone');
                const uploadText = document.getElementById('uploadText');
                dropZone.classList.add('upload-loading');
                uploadText.innerText = "Parsing CSV...";
                Papa.parse(e.target.files[0], { header: true, skipEmptyLines: true, complete: function(results) { 
                    if(window.uploadDataToCloud) {
                        window.uploadDataToCloud(results.data).then(() => {
                            dropZone.classList.remove('upload-loading');
                            uploadText.innerText = "Upload CSV (Append Mode)";
                            e.target.value = '';
                        });
                    }
                }}); 
            }
        });

        // --- CUSTOM MODAL AUTH LOGIC ---
        window.openAuthModal = function(el) {
            if (isAuthorized) return; // Already unlocked
            pendingAuthEl = el;
            const modal = document.getElementById('authModal');
            const input = document.getElementById('modalPassInput');
            const error = document.getElementById('modalErrorMsg');
            
            modal.classList.remove('hidden');
            input.value = '';
            input.focus();
            error.classList.add('hidden');
        };

        window.closeAuthModal = function() {
            document.getElementById('authModal').classList.add('hidden');
            pendingAuthEl = null;
        };

        window.confirmAuth = function() {
            const input = document.getElementById('modalPassInput');
            const error = document.getElementById('modalErrorMsg');
            
            if (input.value === "TAB123") {
                isAuthorized = true;
                
                // Unlock visuals
                document.getElementById('lockIcon').className = "fas fa-lock-open mr-1 text-green-600";
                
                // Unlock all inputs
                const inputs = document.querySelectorAll('.note-input');
                inputs.forEach(inp => {
                    inp.removeAttribute('readonly');
                    inp.classList.remove('bg-slate-100', 'cursor-pointer');
                    inp.classList.add('bg-white');
                    inp.placeholder = "Tulis kendala...";
                    // Remove click listener to prevent reopening modal
                    inp.onclick = null;
                });

                // Focus back on clicked element
                if (pendingAuthEl) {
                    pendingAuthEl.removeAttribute('readonly');
                    pendingAuthEl.focus();
                }
                
                closeAuthModal();
            } else {
                error.classList.remove('hidden');
                input.classList.add('border-rose-500', 'ring-1', 'ring-rose-500');
                setTimeout(() => input.classList.remove('border-rose-500', 'ring-1', 'ring-rose-500'), 1000);
            }
        };

        function parseDate(dateStr) {
            if(!dateStr) return null;
            let safeDateStr = dateStr;
            const monthMap = { 'Mei': 'May', 'Ags': 'Aug', 'Okt': 'Oct', 'Des': 'Dec' };
            for (const [id, en] of Object.entries(monthMap)) { if (safeDateStr.includes(id)) safeDateStr = safeDateStr.replace(id, en); }
            const date = new Date(safeDateStr);
            return isNaN(date.getTime()) ? null : date;
        }

        // --- NEW LOGIC: HANDOVER DATE ---
        function getHandoverDateObj(receiveDateStr, timeStr) {
            if (!receiveDateStr) return null;
            const d = parseDate(receiveDateStr);
            if (!d) return null;
            if (timeStr && timeStr !== '-') {
                const parts = timeStr.split(':');
                const hour = parseInt(parts[0]);
                if (hour >= 15) d.setDate(d.getDate() + 1); // +1 Day if >= 15:00
            }
            return d;
        }

        // Helper untuk parse tanggal + jam menjadi Date Object untuk sorting presisi
        function getFullReceiveDateObj(dateStr, timeStr) {
            if (!dateStr) return null;
            const d = parseDate(dateStr);
            if (!d) return null;
            if (timeStr && timeStr !== '-') {
                const parts = timeStr.split(':');
                if (parts.length >= 2) {
                    d.setHours(parseInt(parts[0]), parseInt(parts[1]));
                }
            }
            return d;
        }

        function calculateHandover(dateStr, timeStr) {
            const d = getHandoverDateObj(dateStr, timeStr);
            if(!d) return '-';
            const day = String(d.getDate()).padStart(2, '0');
            const month = MONTH_NAMES[d.getMonth()];
            const year = d.getFullYear();
            return `${day} ${month} ${year}`;
        }

        function calculateDiffDays(start, end) {
            if (!start || !end) return null;
            const diffTime = Math.abs(end - start);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        }

        function getTimeRange(timeStr) {
            if (!timeStr) return null;
            const hour = parseInt(timeStr.split(':')[0]);
            if (hour >= 0 && hour < 3) return "00-03";
            if (hour >= 3 && hour < 6) return "03-06";
            if (hour >= 6 && hour < 9) return "06-09";
            if (hour >= 9 && hour < 12) return "09-12";
            if (hour >= 12 && hour < 15) return "12-15";
            if (hour >= 15 && hour < 18) return "15-18";
            if (hour >= 18 && hour < 21) return "18-21";
            if (hour >= 21 && hour <= 24) return "21-24";
            return "Lainnya";
        }

        window.processRawData = function(results) {
            const data = results.data;
            allProcessedData = [];
            data.forEach(row => {
                const paDateStr = row['Tanggal']; 
                const receiveDateStr = row['Tanggal DIterima'] || row['Tanggal Diterima'];
                const timeStr = row['JAM'];
                let destRaw = row['Destinasi'];
                if (!paDateStr || !receiveDateStr || !destRaw) return;

                let dest = destRaw.toUpperCase().trim();
                if (dest === 'PALANGKARAYA' || dest === 'BANJAR MASIN') dest = 'BANJARMASIN';

                // --- SLA LOGIC (PA to Handover) ---
                const paDateObj = parseDate(paDateStr);
                const handoverDateObj = getHandoverDateObj(receiveDateStr, timeStr);
                const sla = calculateDiffDays(paDateObj, handoverDateObj);

                if (sla !== null) {
                    allProcessedData.push({
                        ...row,
                        slaComputed: sla,
                        destNormalized: dest,
                        dateStartObj: paDateObj,
                        dateEndObj: parseDate(receiveDateStr), 
                        weight: parseFloat(row['Berat Total (kg)']) || 0,
                        parcels: parseFloat(row['Kuantitas Paket (Awb)']) || 0
                    });
                }
            });
            initFilters();
            applyFilters();
        };

        function initFilters() {
            const vendors = new Set(), dests = new Set();
            allProcessedData.forEach(row => {
                if(row['VENDOR']) vendors.add(row['VENDOR']);
                if(row.destNormalized) dests.add(row.destNormalized);
            });
            const vSelect = document.getElementById('filterVendor'), dSelect = document.getElementById('filterDest');
            const vVal = vSelect.value, dVal = dSelect.value;
            vSelect.innerHTML = '<option value="all">Semua Vendor</option>';
            dSelect.innerHTML = '<option value="all">Semua Destinasi</option>';
            Array.from(vendors).sort().forEach(v => vSelect.innerHTML += `<option value="${v}">${v}</option>`);
            Array.from(dests).sort().forEach(d => dSelect.innerHTML += `<option value="${d}">${d}</option>`);
            if(Array.from(vendors).includes(vVal)) vSelect.value = vVal;
            if(Array.from(dests).includes(dVal)) dSelect.value = dVal;
        }

        window.applyFilters = function() {
            const vendorVal = document.getElementById('filterVendor').value;
            const destVal = document.getElementById('filterDest').value;
            const startVal = document.getElementById('filterStartDate').value;
            const endVal = document.getElementById('filterEndDate').value;
            const start = startVal ? new Date(startVal) : null;
            const end = endVal ? new Date(endVal) : null;
            if(end) end.setHours(23, 59, 59, 999); 

            const filteredData = allProcessedData.filter(row => {
                if (vendorVal !== 'all' && row['VENDOR'] !== vendorVal) return false;
                if (destVal !== 'all' && row.destNormalized !== destVal) return false;
                if (start && row.dateEndObj < start) return false;
                if (end && row.dateEndObj > end) return false;
                return true;
            });
            calculateMetricsAndRender(filteredData);
        };

        function calculateMetricsAndRender(data) {
            let weight = 0, parcels = 0, slaByDest = {}, volStats = {}, vendorStats = {}, availableMonths = new Set();
            let minSLA = Infinity, maxSLA = -Infinity;

            data.forEach(row => {
                weight += row.weight; parcels += row.parcels;
                if (row.slaComputed < minSLA) minSLA = row.slaComputed;
                if (row.slaComputed > maxSLA) maxSLA = row.slaComputed;

                const rDate = row['Tanggal DIterima'] || row['Tanggal Diterima'];
                if(rDate) {
                    if (!volStats[rDate]) volStats[rDate] = { mb: 0, parcel: 0, dateObj: row.dateEndObj };
                    volStats[rDate].mb += 1;
                    volStats[rDate].parcel += row.parcels;
                }

                const dest = row.destNormalized;
                if (!slaByDest[dest]) slaByDest[dest] = { total: 0, count: 0 };
                slaByDest[dest].total += row.slaComputed; slaByDest[dest].count++;
                
                const month = row.dateEndObj.getMonth();
                availableMonths.add(month);
                
                const vKey = `${row['VENDOR']}||${dest}`;
                if (!vendorStats[vKey]) vendorStats[vKey] = { vendor: row['VENDOR'], dest: dest, mb: 0, qty: 0, time: {}, sla: {} };
                const v = vendorStats[vKey]; v.mb++; v.qty += row.parcels;
                const range = getTimeRange(row['JAM']); if (range) v.time[range] = (v.time[range] || 0) + 1;
                if (!v.sla[month]) v.sla[month] = []; v.sla[month].push(row.slaComputed);
            });

            document.getElementById('totalShipments').innerText = data.length.toLocaleString('id-ID');
            document.getElementById('totalWeight').innerText = weight.toLocaleString('id-ID');
            document.getElementById('totalParcels').innerText = parcels.toLocaleString('id-ID');
            document.getElementById('avgSLA').innerText = data.length ? (data.reduce((a,b)=>a+b.slaComputed,0)/data.length).toFixed(1) : 0;
            document.getElementById('minSLA').innerText = data.length ? minSLA : 0;
            document.getElementById('maxSLA').innerText = data.length ? maxSLA : 0;

            renderVendorTable(vendorStats, Array.from(availableMonths).sort((a,b)=>a-b));
            renderSLADistributionTable(data, parcels); 
            renderCharts(slaByDest, volStats);
            renderRawTable(data);
        }

        function renderSLADistributionTable(data, grandTotalQty) {
            const head = document.getElementById('slaDistHeader'), body = document.getElementById('slaDistBody'), footer = document.getElementById('slaDistFooter');
            const uniqueSLAs = [...new Set(data.map(d => d.slaComputed))].sort((a,b) => a-b);
            
            let headerHTML = `<tr class="bg-slate-50 text-[11px] uppercase font-bold text-slate-500 tracking-wider"><th class="px-6 py-3 border-b border-slate-100">Destinasi</th><th class="px-6 py-3 border-b border-slate-100">Vendor</th>`;
            uniqueSLAs.forEach(sla => headerHTML += `<th class="px-6 py-3 border-b border-slate-100 text-center">${sla} Hari</th>`);
            headerHTML += `</tr>`; head.innerHTML = headerHTML;

            const matrix = {}, colTotals = {};
            data.forEach(row => {
                const key = `${row.destNormalized}||${row['VENDOR']}`;
                if (!matrix[key]) matrix[key] = { dest: row.destNormalized, vendor: row['VENDOR'], counts: {} };
                if (!matrix[key].counts[row.slaComputed]) matrix[key].counts[row.slaComputed] = { mb: 0, qty: 0 };
                matrix[key].counts[row.slaComputed].mb++; matrix[key].counts[row.slaComputed].qty += row.parcels;
                if (!colTotals[row.slaComputed]) colTotals[row.slaComputed] = { mb: 0, qty: 0 };
                colTotals[row.slaComputed].mb++; colTotals[row.slaComputed].qty += row.parcels;
            });

            body.innerHTML = '';
            Object.keys(matrix).sort((a,b) => matrix[a].dest.localeCompare(matrix[b].dest)).forEach(key => {
                const item = matrix[key];
                const tr = document.createElement('tr'); tr.className = "hover:bg-emerald-50/20 transition-colors";
                let rowHTML = `<td class="px-6 py-4 border-b border-slate-50 font-bold text-indigo-700">${item.dest}</td><td class="px-6 py-4 border-b border-slate-50 font-medium text-slate-700">${item.vendor}</td>`;
                uniqueSLAs.forEach(sla => {
                    const val = item.counts[sla];
                    rowHTML += val ? `<td class="px-6 py-4 border-b border-slate-50 text-center"><div class="flex flex-col gap-1"><span class="text-xs font-mono text-slate-600 bg-blue-50 px-2 py-0.5 rounded border border-blue-100">${val.mb.toLocaleString('id-ID')}</span><span class="text-xs font-mono text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded border border-emerald-100">${val.qty.toLocaleString('id-ID')}</span></div></td>` : `<td class="px-6 py-4 border-b border-slate-50 text-center"><span class="text-slate-200">-</span></td>`;
                });
                tr.innerHTML = rowHTML; body.appendChild(tr);
            });

            let footerHTML = `<tr><td class="px-6 py-4 text-right text-indigo-900 uppercase tracking-wider" colspan="2">TOTAL & % KONTRIBUSI</td>`;
            uniqueSLAs.forEach(sla => {
                const t = colTotals[sla] || { mb: 0, qty: 0 };
                const pct = grandTotalQty > 0 ? ((t.qty / grandTotalQty) * 100).toFixed(1) : 0;
                footerHTML += `<td class="px-6 py-4 text-center"><div class="flex flex-col gap-1"><span class="text-xs font-bold text-slate-700">MB: ${t.mb.toLocaleString('id-ID')}</span><span class="text-xs font-bold text-slate-700">Qty: ${t.qty.toLocaleString('id-ID')}</span><span class="text-[10px] font-bold ${pct>20?'text-indigo-600':'text-slate-500'} mt-1 bg-white px-2 py-0.5 rounded shadow-sm border border-slate-200">${pct}%</span></div></td>`;
            });
            footer.innerHTML = footerHTML + '</tr>';
        }

        function renderVendorTable(stats, months) {
            const head = document.getElementById('vendorTableHeader'), body = document.getElementById('vendorTableBody');
            let hHTML = `<th class="px-6 py-3">Destinasi</th><th class="px-6 py-3">Vendor</th><th class="px-6 py-3 text-right">Total MB</th><th class="px-6 py-3 text-right">Total Qty</th>`;
            months.forEach(m => hHTML += `<th class="px-6 py-3 text-center">SLA ${MONTH_NAMES[m]}</th>`);
            hHTML += `<th class="px-6 py-3 text-center">Jam Dominan</th>`; head.innerHTML = hHTML; body.innerHTML = '';
            Object.keys(stats).sort().forEach(k => {
                const s = stats[k]; let dom = "-", max = 0; for (const r in s.time) if(s.time[r]>max) { max=s.time[r]; dom=r; }
                const tr = document.createElement('tr'); tr.className = "hover:bg-indigo-50/30 transition-colors group";
                let rHTML = `<td class="px-6 py-3 font-bold text-indigo-700">${s.dest}</td><td class="px-6 py-3 font-medium">${s.vendor}</td><td class="px-6 py-3 text-right font-mono">${s.mb.toLocaleString('id-ID')}</td><td class="px-6 py-3 text-right font-mono">${s.qty.toLocaleString('id-ID')}</td>`;
                months.forEach(m => {
                    const avg = s.sla[m] ? (s.sla[m].reduce((a,b)=>a+b,0)/s.sla[m].length).toFixed(1) : "-";
                    const color = avg==='-'?'':(avg<=4?'bg-emerald-100 text-emerald-700':(avg<=7?'bg-amber-100 text-amber-700':'bg-rose-100 text-rose-700'));
                    rHTML += `<td class="px-6 py-3 text-center"><span class="px-2 py-0.5 rounded-full text-[10px] font-bold ${color}">${avg}</span></td>`;
                });
                tr.innerHTML = rHTML + `<td class="px-6 py-3 text-center"><span class="text-[10px] font-bold bg-slate-100 text-slate-600 px-2 py-1 rounded border border-slate-200">${dom}</span></td>`;
                body.appendChild(tr);
            });
        }

        function renderCharts(sla, volStats) {
            Chart.defaults.font.family = "'Plus Jakarta Sans', sans-serif"; Chart.defaults.color = '#64748b';
            const dCtx = document.getElementById('slaDestChart').getContext('2d'); if (chartSlaDest) chartSlaDest.destroy();
            chartSlaDest = new Chart(dCtx, { type: 'bar', data: { labels: Object.keys(sla), datasets: [{ data: Object.values(sla).map(v=>(v.total/v.count).toFixed(1)), backgroundColor: '#6366f1', borderRadius: 6, barThickness: 50, datalabels: { anchor: 'end', align: 'top', color: '#6366f1', font: { weight: 'bold' } } }] }, plugins: [ChartDataLabels], options: { responsive: true, maintainAspectRatio: false, layout: { padding: { top: 20 } }, plugins: { legend: { display: false }, datalabels: { display: true } }, scales: { y: { display: false }, x: { grid: { display: false } } } } });
            
            const vCtx = document.getElementById('volumeChart').getContext('2d'); if (chartVolume) chartVolume.destroy();
            const sortedDates = Object.keys(volStats).sort((a,b) => volStats[a].dateObj - volStats[b].dateObj);
            chartVolume = new Chart(vCtx, { type: 'line', data: { labels: sortedDates, datasets: [ { label: 'Total MB', data: sortedDates.map(d => volStats[d].mb), borderColor: '#3b82f6', backgroundColor: '#3b82f6', tension: 0.3, datalabels: { align: 'end', anchor: 'end', color: '#3b82f6', font: { weight: 'bold' } } }, { label: 'Total Parcel', data: sortedDates.map(d => volStats[d].parcel), borderColor: '#8b5cf6', backgroundColor: '#8b5cf6', tension: 0.3, datalabels: { align: 'start', anchor: 'start', color: '#8b5cf6', font: { weight: 'bold' } } } ] }, plugins: [ChartDataLabels], options: { responsive: true, maintainAspectRatio: false, layout: { padding: { top: 20 } }, plugins: { legend: { display: false }, datalabels: { display: true } }, scales: { y: { display: false }, x: { grid: { display: false } } } } });
        }

        function renderRawTable(data) {
            const tbody = document.getElementById('tableBody'); tbody.innerHTML = '';
            const groups = {};
            data.forEach(row => {
                const k = `NOTE_${(row['FLIGHT']||'NA').replace(/\W/g,'')}_${(row['VENDOR']||'').replace(/\W/g,'')}_${row.destNormalized}_${(row['Tanggal DIterima']||row['Tanggal Diterima']||'-').replace(/\W/g,'')}_${(row['JAM']||'-').replace(/\W/g,'')}`;
                
                if (!groups[k]) {
                    const rDate = row['Tanggal DIterima']||row['Tanggal Diterima']||'-';
                    const rTime = row['JAM']||'-';
                    
                    // Create GROUP object for this unique shipment
                    groups[k] = { 
                        receiveDate: rDate, 
                        receiveTime: rTime, 
                        handoverDate: calculateHandover(rDate, rTime), 
                        handoverDateObj: getHandoverDateObj(rDate, rTime),
                        fullReceiveDateObj: getFullReceiveDateObj(rDate, rTime),
                        name: row['FLIGHT']||'N/A', 
                        vendor: row['VENDOR'], 
                        dest: row.destNormalized, 
                        paStats: {}, 
                        rawKey: k 
                    };
                }
                
                const paDate = row['Tanggal']; 
                const batch = row['BATCH'] || '-'; 
                const compKey = `${paDate}||${batch}`;
                
                if (!groups[k].paStats[compKey]) groups[k].paStats[compKey] = { mb: 0, qty: 0, sla: row.slaComputed, date: paDate, batch: batch };
                groups[k].paStats[compKey].mb++; groups[k].paStats[compKey].qty += row.parcels;
            });

            // --- 1. CLUSTERING LOGIC: Group by Destinasi + Handover Date ---
            const clusterMap = {};
            
            Object.values(groups).forEach(arrival => {
                // Key for cluster: Dest + Handover Date string
                const clusterKey = `${arrival.dest}||${arrival.handoverDate}`;
                
                if (!clusterMap[clusterKey]) {
                    clusterMap[clusterKey] = {
                        dest: arrival.dest,
                        handoverDate: arrival.handoverDate,
                        handoverDateObj: arrival.handoverDateObj,
                        arrivals: []
                    };
                }
                clusterMap[clusterKey].arrivals.push(arrival);
            });

            // --- 2. SORT CLUSTERS ---
            // Sort clusters by Destinasi (A-Z) -> Handover Date (Desc)
            const sortedClusters = Object.values(clusterMap).sort((a,b) => {
                if (a.dest !== b.dest) return a.dest.localeCompare(b.dest);
                const hA = a.handoverDateObj || new Date(0);
                const hB = b.handoverDateObj || new Date(0);
                return hB - hA;
            });

            if (sortedClusters.length === 0) { tbody.innerHTML = `<tr><td colspan="10" class="px-6 py-8 text-center text-slate-400">Data tidak ditemukan.</td></tr>`; return; }

            // --- 3. RENDER ---
            sortedClusters.forEach((cluster, cIndex) => {
                // Sort Arrivals inside Cluster (Receive Date Desc)
                cluster.arrivals.sort((a,b) => {
                    const rA = a.fullReceiveDateObj || new Date(0);
                    const rB = b.fullReceiveDateObj || new Date(0);
                    return rB - rA;
                });

                // Calculate total rows for this Cluster (for rowspan)
                let totalClusterRows = 0;
                cluster.arrivals.forEach(arr => {
                    totalClusterRows += Object.keys(arr.paStats).length;
                });

                let clusterRowSpanCounter = 0;

                cluster.arrivals.forEach((group, aIndex) => {
                    // Sort PA Stats (Newest Date -> Smallest Batch)
                    const paKeys = Object.keys(group.paStats).sort((a,b) => {
                        const paA = group.paStats[a];
                        const paB = group.paStats[b];
                        const dateA = parseDate(paA.date) || new Date(0);
                        const dateB = parseDate(paB.date) || new Date(0);
                        
                        if (dateB - dateA !== 0) return dateB - dateA; // Date Desc
                        return paA.batch.localeCompare(paB.batch, undefined, {numeric: true}); // Batch Asc
                    });

                    const arrivalRows = paKeys.length;
                    const noteValue = globalNotes[group.rawKey] || "";
                    
                    // Auth logic for note
                    const readOnlyAttr = isAuthorized ? '' : 'readonly';
                    const lockClass = isAuthorized ? 'bg-white' : 'bg-slate-100 cursor-pointer';
                    const placeholder = isAuthorized ? 'Tulis kendala...' : 'Klik untuk buka kunci...';

                    // Group styling
                    let groupClass = (cIndex % 2 === 0) ? 'bg-white' : 'bg-slate-50/50';
                    // Optional: Stronger border between clusters
                    let topBorderClass = (aIndex === 0 && cIndex > 0) ? "border-t-4 border-slate-200" : "border-t border-slate-100";

                    paKeys.forEach((key, i) => {
                        const s = group.paStats[key];
                        const slaColor = s.sla <= 5 ? 'text-emerald-600 bg-emerald-50' : (s.sla <= 7 ? 'text-amber-600 bg-amber-50' : 'text-rose-600 bg-rose-50');
                        const slaBadge = `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold ${slaColor}">${s.sla} Hari</span>`;
                        
                        const tr = document.createElement('tr'); 
                        // First row of cluster gets heavy border, subsequent rows get light border
                        const rowBorder = (i === 0 && aIndex === 0) ? topBorderClass : "border-t border-slate-100";
                        tr.className = `${groupClass} hover:bg-indigo-50/10 transition-colors ${rowBorder}`;
                        
                        let html = '';

                        // 1. Handover SS (Cluster Rowspan) - Printed ONLY on the very first row of the cluster
                        if (aIndex === 0 && i === 0) {
                            html += `
                                <td class="px-6 py-4 align-middle border-r border-slate-100 whitespace-nowrap bg-indigo-50/30 font-bold text-indigo-900" rowspan="${totalClusterRows}">
                                    ${group.handoverDate}
                                </td>
                            `;
                        }

                        // 2. Waktu Terima (Arrival Rowspan)
                        if (i === 0) {
                            html += `
                                <td class="px-6 py-4 align-middle border-r border-slate-100 whitespace-nowrap" rowspan="${arrivalRows}">
                                    <div class="font-bold text-slate-700">${group.receiveDate}</div>
                                    <div class="text-xs text-slate-400 font-mono mt-1 bg-slate-200/50 inline-block px-1.5 py-0.5 rounded">${group.receiveTime}</div>
                                </td>
                            `;
                        }

                        // 3-7. PA Stats (No Rowspan)
                        html += `
                            <td class="px-6 py-3 align-middle border-r border-slate-100 text-slate-600 font-medium whitespace-nowrap"><i class="far fa-calendar-alt text-indigo-400 mr-2"></i>${s.date}</td>
                            <td class="px-6 py-3 align-middle text-center border-r border-slate-100 whitespace-nowrap font-mono text-slate-600">${s.batch}</td>
                            <td class="px-6 py-3 align-middle text-right border-r border-slate-100 font-mono text-slate-600 whitespace-nowrap">${s.mb.toLocaleString('id-ID')}</td>
                            <td class="px-6 py-3 align-middle text-right border-r border-slate-100 font-mono text-slate-600 whitespace-nowrap">${s.qty.toLocaleString('id-ID')}</td>
                            <td class="px-6 py-3 align-middle text-center border-r border-slate-100 whitespace-nowrap">${slaBadge}</td>
                        `;

                        // 8-11. Shipment Info (Arrival Rowspan)
                        if (i === 0) {
                            html += `
                                <td class="px-6 py-4 align-middle border-r border-slate-100 font-bold text-indigo-700 whitespace-nowrap" rowspan="${arrivalRows}">
                                    ${group.name}
                                </td>
                                <td class="px-6 py-4 align-middle border-r border-slate-100 text-slate-600 font-medium whitespace-nowrap" rowspan="${arrivalRows}">
                                    ${group.vendor}
                                </td>
                            `;
                            
                            // DESTINASI: Merged per Cluster or per Arrival?
                            // User request: "jika ada yang sama tanggal endover SS nya untuk destinasi HUB itu di gabung saja"
                            // Means Destinasi should span the whole Cluster.
                            if (aIndex === 0) {
                                html += `
                                    <td class="px-6 py-4 align-middle border-r border-slate-100 whitespace-nowrap bg-white/50" rowspan="${totalClusterRows}">
                                        <span class="inline-flex items-center px-2.5 py-1 rounded text-xs font-bold bg-slate-200 text-slate-700">
                                            ${group.dest}
                                        </span>
                                    </td>
                                `;
                            }

                            html += `
                                <td class="px-4 py-2 align-middle bg-yellow-50/30 border-l border-yellow-100" rowspan="${arrivalRows}">
                                    <textarea 
                                        id="note-${group.rawKey}" 
                                        ${readOnlyAttr} 
                                        onclick="if(!isAuthorized) openAuthModal(this)" 
                                        onchange="if(window.saveNoteToFirebase) window.saveNoteToFirebase('${group.rawKey}', this.value)" 
                                        placeholder="${placeholder}" 
                                        class="w-full h-20 ${lockClass} border border-slate-200 rounded-lg p-2 text-xs text-slate-700 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-transparent resize-none shadow-sm note-input"
                                    >${noteValue}</textarea>
                                </td>
                            `;
                        }

                        tr.innerHTML = html;
                        tbody.appendChild(tr);
                    });
                });
            });
        }
    </script>
</body>
</html>